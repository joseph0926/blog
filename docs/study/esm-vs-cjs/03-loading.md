# 3. 모듈 로딩

[← 목차로 돌아가기](./README.md) | [← 이전: 심화 개념](./02-advanced.md)

---

## Q&A: 정적 분석과 비동기 로딩

### Q: 비동기적으로 로드되는데 정적 분석이 가능한 게 잘 매칭이 안 됩니다.

### A: 두 개념은 **다른 시점**을 말합니다.

| 시점       | 정적 분석                       | 비동기 로딩               |
| ---------- | ------------------------------- | ------------------------- |
| **언제**   | 파싱 타임 (코드 실행 전)        | 런타임 (실제 실행 시)     |
| **무엇을** | "어떤 모듈을 import하는지" 파악 | 모듈 파일을 실제로 가져옴 |

**정적 분석이 가능한 이유**: ESM의 `import`는 **파일 최상단에만** 올 수 있습니다.

```javascript
// ESM - 정적 분석 가능
import { foo } from './module.js'; // 항상 최상단

// CJS - 정적 분석 불가
if (condition) {
  const foo = require('./module.js'); // 런타임에 결정됨
}
```

**핵심 정리**:

```
[빌드 타임]
   ↓
코드 파싱 → "import 문 발견" → 의존성 그래프 구축 (정적 분석)
   ↓
[런타임]
   ↓
모듈 파일 로드 (비동기 I/O) → 모든 의존성 준비 → 코드 실행
```

---

## Q&A: CJS에서 정적 분석

### Q: `require()`도 조건문 안에 안 쓴다는 규칙을 강제하면 정적 분석이 가능한가요?

### A: 부분적으로 맞지만, 완벽하지 않습니다.

**1. 문법적 강제 vs 린트 규칙**

|               | ESM                     | CJS                   |
| ------------- | ----------------------- | --------------------- |
| **강제 수준** | 언어 문법 (파서가 거부) | 린트 규칙 (우회 가능) |

**2. export 쪽 문제**

```javascript
// CJS - 런타임에 결정
module.exports = condition ? { a } : { b };

// ESM - 정적으로 고정
export { a, b };
```

Tree-shaking은 "import 하는 쪽"과 "export 하는 쪽" 둘 다 정적이어야 합니다.

---

## ESM 로딩 3단계

```
1. Construction (파싱)     ─┐
   - import 문 발견        │ 병렬/비동기로 파일 fetch
   - 모듈 그래프 구축      ─┘
          ↓
2. Instantiation (연결)
   - export/import 바인딩
          ↓
    ══════════════════════  ← 여기가 "장벽" (모든 모듈 준비 완료)
          ↓
3. Evaluation (실행)
   - 코드 실행 (의존성 순서대로)
```

| 단계              | 동작 방식                                  |
| ----------------- | ------------------------------------------ |
| 파일 로드 (fetch) | **비동기, 병렬** (A.js, B.js, C.js 동시에) |
| 코드 실행 시작    | **동기적 장벽** (모든 모듈 로드 완료 후)   |
| 실행 순서         | 의존성 순서대로 (leaf → root)              |

---

## Q&A: 병렬 로딩의 실제 이점

### Q: ESM이 병렬로 로드해도 결국 같은 시간 아닌가요?

### A: **여러 독립 모듈**이 있을 때 차이가 납니다.

```javascript
import { a } from './a.js'; // 3초
import { b } from './b.js'; // 1초
import { c } from './c.js'; // 1초
```

```
CJS:  [===a===][=b=][=c=]  → 5초 (순차)
ESM:  [===a===]            → 3초 (병렬)
      [=b=]
      [=c=]
```

| 환경         | 병렬 로드 이점         |
| ------------ | ---------------------- |
| **브라우저** | 큼 (네트워크 I/O 병목) |
| **Node.js**  | 작음 (파일 I/O 빠름)   |

---

[다음: Top-level Await →](./04-top-level-await.md)
